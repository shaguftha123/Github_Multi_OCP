name: Deploy OpenShift Config and Secrets

on:
  push:
    branches:
      - "**"
  pull_request:
    branche;s:
      - "**"         # Also runs on PRs targeting main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      KUBECONFIG: ${{ secrets.KUBECONFIG }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz -C /usr/local/bin oc
          chmod +x /usr/local/bin/oc

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${KUBECONFIG}" > ~/.kube/config

      - name: Apply shared ConfigMap
        run: |
          oc apply -f config/ocp_config_mapping.yaml

      - name: Apply environment-specific secrets
        run: |
          # Extract environment from branch name: feature/dev/xyz â†’ dev
          ENV=$(echo "${GITHUB_REF##*/}" | grep -Eo 'dev|qa|prod' || echo "dev")
          echo "Detected environment: $ENV"
          oc
